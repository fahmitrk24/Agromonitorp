<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petani Cerdas - Aplikasi Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-icon, .action-icon {
            width: 20px;
            height: 20px;
        }
        .card-icon {
            width: 48px;
            height: 48px;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for the date picker */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
        /* Mobile sidebar styles */
        #sidebar.hidden {
            transform: translateX(-100%);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Section -->
    <div id="login-section" class="flex items-center justify-center min-h-screen bg-cover bg-center" style="background-color: #344E41;">
        <div class="bg-white bg-opacity-80 backdrop-blur-sm p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="flex justify-center mb-6">
                 <div class="bg-green-600 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                 </div>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Petani Cerdas</h1>
            <p class="text-gray-600 mb-6">Silakan masuk untuk melanjutkan</p>
            <form id="login-form">
                <div class="mb-4">
                    <input type="text" id="username" placeholder="Nama Pengguna" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" value="admin">
                </div>
                <div class="mb-6">
                    <input type="password" id="password" placeholder="Kata Sandi" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" value="admin">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors duration-300">LOGIN</button>
            </form>
            <p id="login-error" class="text-red-500 mt-4 text-sm"></p>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="hidden">
        <div class="relative flex min-h-screen">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-white shadow-lg flex-col fixed inset-y-0 left-0 z-30 transform transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:flex">
                <div class="flex items-center justify-center h-20 border-b">
                    <div class="bg-green-600 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    </div>
                    <span class="ml-3 text-2xl font-bold text-gray-800">Petani Cerdas</span>
                </div>
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="#dashboard" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-green-100 hover:text-green-700 transition-colors duration-200">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                        <span class="ml-4 font-medium">Dashboard</span>
                    </a>
                    <a href="#petani" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-green-100 hover:text-green-700 transition-colors duration-200">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <span class="ml-4 font-medium">Petani</span>
                    </a>
                    <a href="#lahan" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-green-100 hover:text-green-700 transition-colors duration-200">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h10a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 11l-.544 4M16.263 11l.544 4M12 6a2 2 0 100 4 2 2 0 000-4z"></path></svg>
                        <span class="ml-4 font-medium">Lahan</span>
                    </a>
                    <a href="#alat" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-green-100 hover:text-green-700 transition-colors duration-200">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>
                        <span class="ml-4 font-medium">Alat</span>
                    </a>
                    <a href="#tanaman" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-green-100 hover:text-green-700 transition-colors duration-200">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        <span class="ml-4 font-medium">Tanaman</span>
                    </a>
                    <a href="#penyiraman" class="nav-link flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-green-100 hover:text-green-700 transition-colors duration-200">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l-3 3m6 0l-3-3m-3 12l-3 3m6 0l-3-3"></path></svg>
                        <span class="ml-4 font-medium">Penyiraman</span>
                    </a>
                </nav>
                <div class="px-4 py-6 border-t">
                    <button id="logout-button" class="w-full flex items-center justify-center px-4 py-3 text-red-700 rounded-lg hover:bg-red-100 transition-colors duration-200">
                        <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span class="ml-4 font-medium">Keluar</span>
                    </button>
                </div>
            </aside>
            
            <!-- Overlay for mobile -->
            <div id="sidebar-overlay" class="hidden md:hidden fixed inset-0 bg-black opacity-50 z-20"></div>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col md:ml-64">
                <!-- Top bar for mobile -->
                <header class="md:hidden bg-white shadow-md p-4 flex justify-between items-center">
                    <button id="menu-toggle" class="text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="page-title-mobile" class="text-xl font-bold text-gray-800">Dashboard</h1>
                    <div></div>
                </header>

                <main class="flex-1 p-6 md:p-10 overflow-y-auto">
                    <!-- Page: Dashboard -->
                    <div id="page-dashboard" class="page-content">
                        <h1 class="text-4xl font-bold text-gray-800 mb-8 hidden md:block">Dashboard</h1>
                        <!-- Summary Cards -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                            <div class="bg-white p-6 rounded-2xl shadow-md flex items-center">
                                <div class="p-4 bg-blue-100 rounded-full"><svg class="card-icon text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.28-1.25-1.44-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.28-1.25 1.44-1.857M12 12a3 3 0 100-6 3 3 0 000 6z"></path></svg></div>
                                <div class="ml-4">
                                    <p class="text-gray-500">Total Petani</p>
                                    <p id="total-petani" class="text-3xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-md flex items-center">
                                <div class="p-4 bg-green-100 rounded-full"><svg class="card-icon text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
                                <div class="ml-4">
                                    <p class="text-gray-500">Total Lahan</p>
                                    <p id="total-lahan" class="text-3xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-md flex items-center">
                                <div class="p-4 bg-yellow-100 rounded-full"><svg class="card-icon text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg></div>
                                <div class="ml-4">
                                    <p class="text-gray-500">Total Alat</p>
                                    <p id="total-alat" class="text-3xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-md flex items-center">
                                <div class="p-4 bg-indigo-100 rounded-full"><svg class="card-icon text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l-3 3m6 0l-3-3m-3 12l-3 3m6 0l-3-3"></path></svg></div>
                                <div class="ml-4">
                                    <p class="text-gray-500">Total Penyiraman</p>
                                    <p id="total-penyiraman" class="text-3xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        <!-- Dashboard Table -->
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Daftar Tanaman & Status</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-gray-50 text-gray-600 uppercase text-sm">
                                            <th class="p-4">ID</th>
                                            <th class="p-4">Jenis Jagung</th>
                                            <th class="p-4">Lokasi</th>
                                            <th class="p-4">Petani</th>
                                            <th class="p-4">Umur (Hari)</th>
                                            <th class="p-4">Kelembapan (%)</th>
                                            <th class="p-4">Status Lahan</th>
                                            <th class="p-4">Rekomendasi Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dashboard-table-body" class="divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Petani -->
                    <div id="page-petani" class="page-content hidden">
                        <h1 class="text-4xl font-bold text-gray-800 mb-8 hidden md:block">Manajemen Petani</h1>
                        <!-- Form Petani -->
                        <div class="bg-white p-8 rounded-2xl shadow-md mb-10">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6" id="petani-form-title">Tambah Petani Baru</h2>
                            <form id="petani-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <input type="hidden" id="petani-id">
                                <div>
                                    <label for="petani-nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Petani</label>
                                    <input type="text" id="petani-nama" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                </div>
                                <div>
                                    <label for="petani-hp" class="block text-sm font-medium text-gray-700 mb-1">No. HP</label>
                                    <input type="tel" id="petani-hp" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label for="petani-alamat" class="block text-sm font-medium text-gray-700 mb-1">Alamat</label>
                                    <input type="text" id="petani-alamat" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                                <div class="md:col-span-3 flex justify-end space-x-3">
                                    <button type="button" id="petani-cancel" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors">Batal</button>
                                    <button type="submit" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">Simpan</button>
                                </div>
                            </form>
                        </div>
                        <!-- Table Petani -->
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Daftar Petani</h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-gray-50 text-gray-600 uppercase text-sm">
                                            <th class="p-4">ID</th>
                                            <th class="p-4">Nama</th>
                                            <th class="p-4">No. HP</th>
                                            <th class="p-4">Alamat</th>
                                            <th class="p-4">Jumlah Lahan</th>
                                            <th class="p-4">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="petani-table-body" class="divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Lahan -->
                    <div id="page-lahan" class="page-content hidden">
                        <h1 class="text-4xl font-bold text-gray-800 mb-8 hidden md:block">Manajemen Lahan</h1>
                        <!-- Form Lahan -->
                        <div class="bg-white p-8 rounded-2xl shadow-md mb-10">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6" id="lahan-form-title">Tambah Lahan Baru</h2>
                            <form id="lahan-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                                <input type="hidden" id="lahan-id">
                                <div>
                                    <label for="lahan-petani-id" class="block text-sm font-medium text-gray-700 mb-1">Petani Penanggung Jawab</label>
                                    <select id="lahan-petani-id" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required></select>
                                </div>
                                <div>
                                    <label for="lahan-lokasi" class="block text-sm font-medium text-gray-700 mb-1">Lokasi Lahan</label>
                                    <input type="text" id="lahan-lokasi" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                </div>
                                <div>
                                    <label for="lahan-luas" class="block text-sm font-medium text-gray-700 mb-1">Luas (m²)</label>
                                    <input type="number" step="0.1" id="lahan-luas" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                </div>
                                <div>
                                    <label for="lahan-kelembapan" class="block text-sm font-medium text-gray-700 mb-1">Kelembapan (%)</label>
                                    <input type="number" step="0.1" id="lahan-kelembapan" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                </div>
                                <div>
                                    <label for="lahan-status" class="block text-sm font-medium text-gray-700 mb-1">Status Lahan</label>
                                    <select id="lahan-status" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                        <option value="Aktif">Aktif</option>
                                        <option value="Tidak Aktif">Tidak Aktif</option>
                                    </select>
                                </div>
                                <div class="lg:col-span-5 flex justify-end space-x-3">
                                    <button type="button" id="lahan-cancel" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors">Batal</button>
                                    <button type="submit" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">Simpan</button>
                                </div>
                            </form>
                        </div>
                        <!-- Table Lahan -->
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Daftar Lahan</h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-gray-50 text-gray-600 uppercase text-sm">
                                            <th class="p-4">ID</th>
                                            <th class="p-4">Petani</th>
                                            <th class="p-4">Lokasi</th>
                                            <th class="p-4">Luas (m²)</th>
                                            <th class="p-4">Kelembapan (%)</th>
                                            <th class="p-4">Status</th>
                                            <th class="p-4">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lahan-table-body" class="divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Alat -->
                    <div id="page-alat" class="page-content hidden">
                        <h1 class="text-4xl font-bold text-gray-800 mb-8 hidden md:block">Manajemen Alat</h1>
                        <!-- Form Alat -->
                        <div class="bg-white p-8 rounded-2xl shadow-md mb-10">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6" id="alat-form-title">Tambah Alat Baru</h2>
                            <form id="alat-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                                <input type="hidden" id="alat-id">
                                <div>
                                    <label for="alat-nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Alat</label>
                                    <input type="text" id="alat-nama" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                </div>
                                <div>
                                    <label for="alat-tipe" class="block text-sm font-medium text-gray-700 mb-1">Tipe Sensor</label>
                                    <select id="alat-tipe" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                        <option value="Sensor Penyiraman">Sensor Penyiraman</option>
                                        <option value="Sensor Kelembapan">Sensor Kelembapan</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="alat-kondisi" class="block text-sm font-medium text-gray-700 mb-1">Kondisi Alat</label>
                                    <select id="alat-kondisi" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                        <option value="Baik">Baik</option>
                                        <option value="Rusak">Rusak</option>
                                        <option value="Perlu Perawatan">Perlu Perawatan</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="alat-status" class="block text-sm font-medium text-gray-700 mb-1">Status Alat</label>
                                    <select id="alat-status" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                        <option value="Aktif">Aktif</option>
                                        <option value="Tidak Aktif">Tidak Aktif</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="alat-lahan-id" class="block text-sm font-medium text-gray-700 mb-1">Lokasi Terpasang</label>
                                    <select id="alat-lahan-id" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"></select>
                                </div>
                                <div class="lg:col-span-5 flex justify-end space-x-3">
                                    <button type="button" id="alat-cancel" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors">Batal</button>
                                    <button type="submit" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">Simpan</button>
                                </div>
                            </form>
                        </div>
                        <!-- Table Alat -->
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Daftar Alat</h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-gray-50 text-gray-600 uppercase text-sm">
                                            <th class="p-4">ID</th>
                                            <th class="p-4">Nama Alat</th>
                                            <th class="p-4">Tipe Sensor</th>
                                            <th class="p-4">Status</th>
                                            <th class="p-4">Kondisi</th>
                                            <th class="p-4">Lokasi</th>
                                            <th class="p-4">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="alat-table-body" class="divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Tanaman -->
                    <div id="page-tanaman" class="page-content hidden">
                        <h1 class="text-4xl font-bold text-gray-800 mb-8 hidden md:block">Manajemen Tanaman</h1>
                         <!-- Form Tanaman -->
                        <div class="bg-white p-8 rounded-2xl shadow-md mb-10">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6" id="tanaman-form-title">Tambah Tanaman Baru</h2>
                            <form id="tanaman-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <input type="hidden" id="tanaman-id">
                                <div>
                                    <label for="tanaman-lahan-id" class="block text-sm font-medium text-gray-700 mb-1">Lokasi Lahan</label>
                                    <select id="tanaman-lahan-id" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required></select>
                                </div>
                                <div>
                                    <label for="tanaman-jenis" class="block text-sm font-medium text-gray-700 mb-1">Jenis Jagung</label>
                                    <select id="tanaman-jenis" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                        <option value="Jagung Manis">Jagung Manis</option>
                                        <option value="Jagung Mutiara">Jagung Mutiara</option>
                                        <option value="Jagung Ketan">Jagung Ketan</option>
                                        <option value="Jagung Pulen">Jagung Pulen</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tanaman-tgl-tanam" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Tanam</label>
                                    <input type="date" id="tanaman-tgl-tanam" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                </div>
                                <div>
                                    <label for="tanaman-umur-panen" class="block text-sm font-medium text-gray-700 mb-1">Umur Panen (Hari)</label>
                                    <input type="number" id="tanaman-umur-panen" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                </div>
                                <div class="lg:col-span-4 flex justify-end space-x-3">
                                    <button type="button" id="tanaman-cancel" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors">Batal</button>
                                    <button type="submit" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">Simpan</button>
                                </div>
                            </form>
                        </div>
                        <!-- Table Tanaman -->
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Daftar Tanaman</h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-gray-50 text-gray-600 uppercase text-sm">
                                            <th class="p-4">ID</th>
                                            <th class="p-4">Lokasi Lahan</th>
                                            <th class="p-4">Jenis Tanaman</th>
                                            <th class="p-4">Tanggal Tanam</th>
                                            <th class="p-4">Umur Panen (Hari)</th>
                                            <th class="p-4">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tanaman-table-body" class="divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Penyiraman -->
                    <div id="page-penyiraman" class="page-content hidden">
                        <h1 class="text-4xl font-bold text-gray-800 mb-8 hidden md:block">Rekomendasi & Riwayat Penyiraman</h1>
                         <!-- Form Penyiraman -->
                        <div class="bg-white p-8 rounded-2xl shadow-md mb-10">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6" id="penyiraman-form-title">Catat Penyiraman Baru</h2>
                            <form id="penyiraman-form" class="grid grid-cols-1 gap-6">
                                 <!-- Rekomendasi Section -->
                                <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                                    <h3 class="text-xl font-bold text-green-800 mb-4">Rekomendasi Cerdas</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label for="rekom-petani" class="block text-sm font-medium text-gray-700 mb-1">1. Pilih Petani</label>
                                            <select id="rekom-petani" class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"></select>
                                        </div>
                                        <div>
                                            <label for="rekom-lahan" class="block text-sm font-medium text-gray-700 mb-1">2. Pilih Lahan</label>
                                            <select id="rekom-lahan" class="w-full px-4 py-2 rounded-lg bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" disabled></select>
                                        </div>
                                        <div class="flex items-end">
                                            <button type="button" id="get-rekomendasi-btn" class="w-full px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors" disabled>Dapatkan Rekomendasi</button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Form Inputs -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <input type="hidden" id="penyiraman-id">
                                    <div>
                                        <label for="penyiraman-lahan-id" class="block text-sm font-medium text-gray-700 mb-1">Lahan yang Disiram</label>
                                        <select id="penyiraman-lahan-id" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required></select>
                                    </div>
                                     <div>
                                        <label for="penyiraman-alat-id" class="block text-sm font-medium text-gray-700 mb-1">Alat Digunakan</label>
                                        <select id="penyiraman-alat-id" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"></select>
                                    </div>
                                    <div>
                                        <label for="penyiraman-tgl" class="block text-sm font-medium text-gray-700 mb-1">Tgl & Waktu Siram</label>
                                        <input type="datetime-local" id="penyiraman-tgl" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label for="penyiraman-target" class="block text-sm font-medium text-gray-700 mb-1">Target Kelembapan (%)</label>
                                        <input type="number" id="penyiraman-target" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label for="penyiraman-durasi" class="block text-sm font-medium text-gray-700 mb-1">Durasi (Menit)</label>
                                        <input type="number" id="penyiraman-durasi" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label for="penyiraman-volume" class="block text-sm font-medium text-gray-700 mb-1">Volume Air (Liter)</label>
                                        <input type="number" step="0.1" id="penyiraman-volume" class="w-full px-4 py-2 rounded-lg bg-gray-50 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3">
                                    <button type="button" id="penyiraman-cancel" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors">Batal</button>
                                    <button type="submit" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">Simpan Riwayat</button>
                                </div>
                            </form>
                        </div>
                        <!-- Table Penyiraman -->
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Riwayat Penyiraman</h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-gray-50 text-gray-600 uppercase text-sm">
                                            <th class="p-4">ID</th>
                                            <th class="p-4">Petani</th>
                                            <th class="p-4">Lokasi Lahan</th>
                                            <th class="p-4">Alat</th>
                                            <th class="p-4">Waktu Siram</th>
                                            <th class="p-4">Target (%)</th>
                                            <th class="p-4">Durasi (m)</th>
                                            <th class="p-4">Volume (L)</th>
                                            <th class="p-4">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="penyiraman-table-body" class="divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </main>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal/Alert/Confirm -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center transform transition-all scale-95 opacity-0" id="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // =================================================================================
    // DATABASE SIMULATION (Berdasarkan dbpetani.sql)
    // Di aplikasi nyata, data ini akan diambil dari backend/API.
    // =================================================================================
    let db = {
        users: [
            { id: 1, username: 'admin', password: 'admin' }
        ],
        petani: [
            { id_petani: 1, nama_petani: 'Budi Santoso', no_hp: '081234567890', alamat: 'Desa Sukamaju' },
            { id_petani: 2, nama_petani: 'Siti Aminah', no_hp: '081222333444', alamat: 'Desa Makmur' }
        ],
        lahan: [
            { id_lahan: 1, id_petani: 1, lokasi: 'Blok A1, Sawah Utara', luas: 150, kelembapan: 65, status_lahan: 'Aktif' },
            { id_lahan: 2, id_petani: 2, lokasi: 'Area C, Pinggir Sungai', luas: 120, kelembapan: 55, status_lahan: 'Aktif' }
        ],
        alat: [
            { id_alat: 1, id_lahan: 1, nama_alat: 'Sprinkler V1', tipe_sensor: 'Sensor Penyiraman', kondisi_alat: 'Baik', status_alat: 'Aktif' },
            { id_alat: 2, id_lahan: 2, nama_alat: 'Moisture-100', tipe_sensor: 'Sensor Kelembapan', kondisi_alat: 'Baik', status_alat: 'Aktif' },
            { id_alat: 3, id_lahan: null, nama_alat: 'Sprayer Manual', tipe_sensor: 'Sensor Penyiraman', kondisi_alat: 'Baik', status_alat: 'Tidak Aktif' }
        ],
        tanaman: [
            { id_tanaman: 1, id_lahan: 1, jenis_jagung: 'Jagung Manis', tgl_tanam: '2025-05-10', umur_panen: 90 },
            { id_tanaman: 2, id_lahan: 2, jenis_jagung: 'Jagung Mutiara', tgl_tanam: '2025-05-20', umur_panen: 85 }
        ],
        penyiraman: [
            { id_penyiraman: 1, id_lahan: 1, id_alat: 1, tgl_waktu_siram: '2025-07-05T08:00', target_kelembapan: 80, durasi: 20, volume_air: 200 },
            { id_penyiraman: 2, id_lahan: 2, id_alat: null, tgl_waktu_siram: '2025-07-06T07:00', target_kelembapan: 75, durasi: 25, volume_air: 250 }
        ]
    };

    // =================================================================================
    // KONSTANTA LOGIKA BISNIS (dari home.java)
    // =================================================================================
    const TARGET_KELEMBAPAN_IDEAL = 80.0;
    const KEBUTUHAN_AIR_PER_METER_PER_PERSEN = 1.0;
    const DEBIT_AIR_ALAT_PER_MENIT = 10.0;

    // =================================================================================
    // ELEMEN DOM
    // =================================================================================
    const loginSection = document.getElementById('login-section');
    const appSection = document.getElementById('app-section');
    const loginForm = document.getElementById('login-form');
    const logoutButton = document.getElementById('logout-button');
    const navLinks = document.querySelectorAll('.nav-link');
    const pageContents = document.querySelectorAll('.page-content');
    const modal = document.getElementById('custom-modal');
    const modalContent = document.getElementById('modal-content');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const menuToggle = document.getElementById('menu-toggle');
    const pageTitleMobile = document.getElementById('page-title-mobile');

    // =================================================================================
    // FUNGSI UTILITY & MODAL
    // =================================================================================
    
    const showModal = () => {
        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
        }, 10);
    };

    const hideModal = () => {
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    };
    
    const showAlert = (title, message) => {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        const buttonsDiv = document.getElementById('modal-buttons');
        buttonsDiv.innerHTML = `<button id="modal-ok-btn" class="px-8 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">OK</button>`;
        showModal();
        document.getElementById('modal-ok-btn').addEventListener('click', hideModal, { once: true });
    };

    const showConfirm = (title, message, onConfirm) => {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        const buttonsDiv = document.getElementById('modal-buttons');
        buttonsDiv.innerHTML = `
            <button id="modal-cancel-btn" class="px-8 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors">Batal</button>
            <button id="modal-confirm-btn" class="px-8 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">Hapus</button>
        `;
        showModal();
        
        document.getElementById('modal-cancel-btn').addEventListener('click', hideModal, { once: true });
        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
            hideModal();
            onConfirm();
        }, { once: true });
    };

    const getNewId = (array, key) => {
        if (array.length === 0) return 1;
        return Math.max(...array.map(item => item[key])) + 1;
    };

    const formatDate = (dateString) => {
        if (!dateString) return '-';
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('id-ID', options);
    };

    const formatDateTime = (dateTimeString) => {
        if (!dateTimeString) return '-';
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return new Date(dateTimeString).toLocaleString('id-ID', options);
    };
    
    // =================================================================================
    // LOGIKA LOGIN & NAVIGASI
    // =================================================================================
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const user = db.users.find(u => u.username === username && u.password === password);

        if (user) {
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            navigateTo('#dashboard');
        } else {
            document.getElementById('login-error').textContent = 'Nama Pengguna atau Kata Sandi salah.';
        }
    });

    logoutButton.addEventListener('click', () => {
        appSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
        document.getElementById('username').value = 'admin';
        document.getElementById('password').value = 'admin';
        document.getElementById('login-error').textContent = '';
    });

    const navigateTo = (hash) => {
        pageContents.forEach(page => page.classList.add('hidden'));
        const targetPage = document.getElementById(`page-${hash.substring(1)}`);
        if (targetPage) {
            targetPage.classList.remove('hidden');
        } else {
            document.getElementById('page-dashboard').classList.remove('hidden');
        }

        navLinks.forEach(link => {
            if (link.getAttribute('href') === hash) {
                link.classList.add('bg-green-100', 'text-green-700', 'font-bold');
                pageTitleMobile.textContent = link.querySelector('span').textContent;
            } else {
                link.classList.remove('bg-green-100', 'text-green-700', 'font-bold');
            }
        });
        
        // Hide sidebar on mobile after navigation
        if (window.innerWidth < 768) {
            sidebar.classList.add('hidden');
            sidebarOverlay.classList.add('hidden');
        }
        
        switch(hash) {
            case '#dashboard': renderDashboard(); break;
            case '#petani': renderPetaniTable(); break;
            case '#lahan': renderLahanTable(); populatePetaniDropdown(); break;
            case '#alat': renderAlatTable(); populateLahanDropdownForAlat(); break;
            case '#tanaman': renderTanamanTable(); populateLahanDropdownForTanaman(); break;
            case '#penyiraman': renderPenyiramanTable(); populateDropdownsForPenyiraman(); break;
        }
    };

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const hash = link.getAttribute('href');
            navigateTo(hash);
        });
    });

    // Mobile sidebar toggle
    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
        sidebarOverlay.classList.toggle('hidden');
    });
    sidebarOverlay.addEventListener('click', () => {
        sidebar.classList.add('hidden');
        sidebarOverlay.classList.add('hidden');
    });

    // =================================================================================
    // FUNGSI RENDER
    // =================================================================================

    const renderDashboard = () => {
        document.getElementById('total-petani').textContent = db.petani.length;
        document.getElementById('total-lahan').textContent = db.lahan.length;
        document.getElementById('total-alat').textContent = db.alat.length;
        document.getElementById('total-penyiraman').textContent = db.penyiraman.length;

        const tableBody = document.getElementById('dashboard-table-body');
        tableBody.innerHTML = '';
        if (db.tanaman.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-gray-500">Belum ada data tanaman.</td></tr>`;
            return;
        }
        db.tanaman.forEach(t => {
            const lahan = db.lahan.find(l => l.id_lahan === t.id_lahan);
            if (!lahan) return;
            const petani = db.petani.find(p => p.id_petani === lahan.id_petani);
            
            const tglTanam = new Date(t.tgl_tanam);
            const today = new Date();
            const umur = Math.floor((today - tglTanam) / (1000 * 60 * 60 * 24));
            
            let rekAksi = 'Ideal';
            if (lahan.kelembapan < 60) rekAksi = 'Perlu Siram';
            if (lahan.kelembapan > 90) rekAksi = 'Terlalu Basah';
            
            let rekAksiClass = 'bg-green-100 text-green-800';
            if (rekAksi === 'Perlu Siram') rekAksiClass = 'bg-yellow-100 text-yellow-800';
            if (rekAksi === 'Terlalu Basah') rekAksiClass = 'bg-blue-100 text-blue-800';

            tableBody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4">${t.id_tanaman}</td>
                    <td class="p-4 font-medium text-gray-800">${t.jenis_jagung}</td>
                    <td class="p-4">${lahan.lokasi}</td>
                    <td class="p-4">${petani ? petani.nama_petani : 'N/A'}</td>
                    <td class="p-4">${umur >= 0 ? umur : 0}</td>
                    <td class="p-4 font-semibold">${lahan.kelembapan}%</td>
                    <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${lahan.status_lahan === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${lahan.status_lahan}</span></td>
                    <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${rekAksiClass}">${rekAksi}</span></td>
                </tr>`;
        });
    };

    const renderPetaniTable = () => {
        const tableBody = document.getElementById('petani-table-body');
        tableBody.innerHTML = '';
        if (db.petani.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Belum ada data petani.</td></tr>`;
            return;
        }
        db.petani.forEach(p => {
            const jumlahLahan = db.lahan.filter(l => l.id_petani === p.id_petani).length;
            tableBody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4">${p.id_petani}</td>
                    <td class="p-4 font-medium text-gray-800">${p.nama_petani}</td>
                    <td class="p-4">${p.no_hp}</td>
                    <td class="p-4">${p.alamat}</td>
                    <td class="p-4">${jumlahLahan}</td>
                    <td class="p-4 space-x-2">
                        <button class="edit-petani-btn p-2 rounded-md bg-yellow-100 text-yellow-700 hover:bg-yellow-200" data-id="${p.id_petani}"><svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                        <button class="delete-petani-btn p-2 rounded-md bg-red-100 text-red-700 hover:bg-red-200" data-id="${p.id_petani}"><svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                </tr>`;
        });
    };
    
    const renderLahanTable = () => {
        const tableBody = document.getElementById('lahan-table-body');
        tableBody.innerHTML = '';
        if (db.lahan.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">Belum ada data lahan.</td></tr>`;
            return;
        }
        db.lahan.forEach(l => {
            const petani = db.petani.find(p => p.id_petani === l.id_petani);
            tableBody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4">${l.id_lahan}</td>
                    <td class="p-4 font-medium text-gray-800">${petani ? petani.nama_petani : 'N/A'}</td>
                    <td class="p-4">${l.lokasi}</td>
                    <td class="p-4">${l.luas}</td>
                    <td class="p-4">${l.kelembapan}</td>
                    <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${l.status_lahan === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${l.status_lahan}</span></td>
                    <td class="p-4 space-x-2">
                        <button class="edit-lahan-btn p-2 rounded-md bg-yellow-100 text-yellow-700 hover:bg-yellow-200" data-id="${l.id_lahan}"><svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                        <button class="delete-lahan-btn p-2 rounded-md bg-red-100 text-red-700 hover:bg-red-200" data-id="${l.id_lahan}"><svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                </tr>`;
        });
    };

    const renderAlatTable = () => {
        const tableBody = document.getElementById('alat-table-body');
        tableBody.innerHTML = '';
        if (db.alat.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">Belum ada data alat.</td></tr>`;
            return;
        }
        db.alat.forEach(a => {
            const lahan = db.lahan.find(l => l.id_lahan === a.id_lahan);
            tableBody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4">${a.id_alat}</td>
                    <td class="p-4 font-medium text-gray-800">${a.nama_alat}</td>
                    <td class="p-4">${a.tipe_sensor}</td>
                    <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${a.status_alat === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${a.status_alat}</span></td>
                    <td class="p-4">${a.kondisi_alat}</td>
                    <td class="p-4">${lahan ? lahan.lokasi : 'Tidak Terpasang'}</td>
                    <td class="p-4 space-x-2">
                        <button class="edit-alat-btn p-2 rounded-md bg-yellow-100 text-yellow-700 hover:bg-yellow-200" data-id="${a.id_alat}"><svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                        <button class="delete-alat-btn p-2 rounded-md bg-red-100 text-red-700 hover:bg-red-200" data-id="${a.id_alat}"><svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                </tr>`;
        });
    };

    const renderTanamanTable = () => {
        const tableBody = document.getElementById('tanaman-table-body');
        tableBody.innerHTML = '';
        if (db.tanaman.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Belum ada data tanaman.</td></tr>`;
            return;
        }
        db.tanaman.forEach(t => {
            const lahan = db.lahan.find(l => l.id_lahan === t.id_lahan);
            tableBody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4">${t.id_tanaman}</td>
                    <td class="p-4">${lahan ? lahan.lokasi : 'N/A'}</td>
                    <td class="p-4 font-medium text-gray-800">${t.jenis_jagung}</td>
                    <td class="p-4">${formatDate(t.tgl_tanam)}</td>
                    <td class="p-4">${t.umur_panen}</td>
                    <td class="p-4 space-x-2">
                        <button class="edit-tanaman-btn p-2 rounded-md bg-yellow-100 text-yellow-700 hover:bg-yellow-200" data-id="${t.id_tanaman}"><svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                        <button class="delete-tanaman-btn p-2 rounded-md bg-red-100 text-red-700 hover:bg-red-200" data-id="${t.id_tanaman}"><svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                </tr>`;
        });
    };

    const renderPenyiramanTable = () => {
        const tableBody = document.getElementById('penyiraman-table-body');
        tableBody.innerHTML = '';
        if (db.penyiraman.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-gray-500">Belum ada riwayat penyiraman.</td></tr>`;
            return;
        }
        db.penyiraman.sort((a, b) => new Date(b.tgl_waktu_siram) - new Date(a.tgl_waktu_siram)).forEach(py => {
            const lahan = db.lahan.find(l => l.id_lahan === py.id_lahan);
            const petani = lahan ? db.petani.find(p => p.id_petani === lahan.id_petani) : null;
            const alat = db.alat.find(a => a.id_alat === py.id_alat);
            tableBody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4">${py.id_penyiraman}</td>
                    <td class="p-4 font-medium text-gray-800">${petani ? petani.nama_petani : 'N/A'}</td>
                    <td class="p-4">${lahan ? lahan.lokasi : 'N/A'}</td>
                    <td class="p-4">${alat ? alat.nama_alat : '-'}</td>
                    <td class="p-4">${formatDateTime(py.tgl_waktu_siram)}</td>
                    <td class="p-4">${py.target_kelembapan}</td>
                    <td class="p-4">${py.durasi}</td>
                    <td class="p-4">${py.volume_air}</td>
                    <td class="p-4 space-x-2">
                         <button class="delete-penyiraman-btn p-2 rounded-md bg-red-100 text-red-700 hover:bg-red-200" data-id="${py.id_penyiraman}"><svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                </tr>`;
        });
    };

    // =================================================================================
    // FUNGSI POPULATE DROPDOWN
    // =================================================================================
    const populatePetaniDropdown = () => {
        const select = document.getElementById('lahan-petani-id');
        select.innerHTML = '<option value="">Pilih Petani...</option>';
        db.petani.forEach(p => {
            select.innerHTML += `<option value="${p.id_petani}">${p.nama_petani}</option>`;
        });
    };

    const populateLahanDropdownForAlat = () => {
        const select = document.getElementById('alat-lahan-id');
        select.innerHTML = '<option value="">Tidak Terpasang</option>';
        db.lahan.filter(l => l.status_lahan === 'Aktif').forEach(l => {
            select.innerHTML += `<option value="${l.id_lahan}">${l.lokasi}</option>`;
        });
    };

    const populateLahanDropdownForTanaman = () => {
        const select = document.getElementById('tanaman-lahan-id');
        select.innerHTML = '<option value="">Pilih Lahan...</option>';
        db.lahan.filter(l => l.status_lahan === 'Aktif').forEach(l => {
            select.innerHTML += `<option value="${l.id_lahan}">${l.lokasi}</option>`;
        });
    };

    const populateDropdownsForPenyiraman = () => {
        const rekomPetani = document.getElementById('rekom-petani');
        rekomPetani.innerHTML = '<option value="">Pilih Petani...</option>';
        db.petani.forEach(p => {
            rekomPetani.innerHTML += `<option value="${p.id_petani}">${p.nama_petani}</option>`;
        });
        
        const penyiramanLahan = document.getElementById('penyiraman-lahan-id');
        penyiramanLahan.innerHTML = '<option value="">Pilih Lahan...</option>';
        db.lahan.filter(l => l.status_lahan === 'Aktif').forEach(l => {
            penyiramanLahan.innerHTML += `<option value="${l.id_lahan}">${l.lokasi}</option>`;
        });
    };

    // =================================================================================
    // LOGIKA FORM (CREATE & UPDATE)
    // =================================================================================
    
    const validateAndGetData = (formId, fields) => {
        const data = {};
        for (const field of fields) {
            const element = document.getElementById(`${formId}-${field.name}`);
            let value = element.value.trim();
            if (field.required && !value) {
                showAlert('Input Tidak Valid', `Kolom "${field.label}" tidak boleh kosong.`);
                return null;
            }
            if (value) {
                if (field.type === 'number') {
                    const numValue = parseFloat(value);
                    if (isNaN(numValue)) {
                        showAlert('Input Tidak Valid', `Kolom "${field.label}" harus berupa angka.`);
                        return null;
                    }
                    data[field.key] = numValue;
                } else if (field.type === 'integer') {
                    const intValue = parseInt(value, 10);
                    if (isNaN(intValue)) {
                        showAlert('Input Tidak Valid', `Kolom "${field.label}" harus berupa angka bulat.`);
                        return null;
                    }
                    data[field.key] = intValue;
                } else {
                    data[field.key] = value;
                }
            } else {
                 data[field.key] = field.type === 'number' || field.type === 'integer' ? null : value;
            }
        }
        return data;
    };

    // Form Petani
    document.getElementById('petani-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('petani-id').value;
        const newPetani = {
            nama_petani: document.getElementById('petani-nama').value,
            no_hp: document.getElementById('petani-hp').value,
            alamat: document.getElementById('petani-alamat').value,
        };
        if (!newPetani.nama_petani) {
            showAlert('Input Tidak Valid', 'Nama Petani tidak boleh kosong.');
            return;
        }
        if (id) { 
            const index = db.petani.findIndex(p => p.id_petani == id);
            db.petani[index] = { ...db.petani[index], ...newPetani };
            showAlert('Sukses', 'Data petani berhasil diperbarui.');
        } else {
            newPetani.id_petani = getNewId(db.petani, 'id_petani');
            db.petani.push(newPetani);
            showAlert('Sukses', 'Data petani berhasil disimpan.');
        }
        renderPetaniTable();
        renderDashboard();
        resetPetaniForm();
    });
    
    const resetPetaniForm = () => {
        document.getElementById('petani-form').reset();
        document.getElementById('petani-id').value = '';
        document.getElementById('petani-form-title').textContent = 'Tambah Petani Baru';
    };
    document.getElementById('petani-cancel').addEventListener('click', resetPetaniForm);

    // Form Lahan
    document.getElementById('lahan-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('lahan-id').value;
        const fields = [
            { name: 'petani-id', key: 'id_petani', type: 'integer', required: true, label: 'Petani' },
            { name: 'lokasi', key: 'lokasi', type: 'string', required: true, label: 'Lokasi' },
            { name: 'luas', key: 'luas', type: 'number', required: true, label: 'Luas' },
            { name: 'kelembapan', key: 'kelembapan', type: 'number', required: true, label: 'Kelembapan' },
            { name: 'status', key: 'status_lahan', type: 'string', required: true, label: 'Status' }
        ];
        const newLahan = validateAndGetData('lahan', fields);
        if (!newLahan) return;

        if (id) {
            const index = db.lahan.findIndex(l => l.id_lahan == id);
            db.lahan[index] = { ...db.lahan[index], ...newLahan };
            showAlert('Sukses', 'Data lahan berhasil diperbarui.');
        } else {
            newLahan.id_lahan = getNewId(db.lahan, 'id_lahan');
            db.lahan.push(newLahan);
            showAlert('Sukses', 'Data lahan berhasil disimpan.');
        }
        renderLahanTable();
        renderDashboard();
        resetLahanForm();
    });
    const resetLahanForm = () => {
        document.getElementById('lahan-form').reset();
        document.getElementById('lahan-id').value = '';
        document.getElementById('lahan-form-title').textContent = 'Tambah Lahan Baru';
    };
    document.getElementById('lahan-cancel').addEventListener('click', resetLahanForm);

    // Form Alat
    document.getElementById('alat-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('alat-id').value;
        const lahanIdValue = document.getElementById('alat-lahan-id').value;
        const newAlat = {
            nama_alat: document.getElementById('alat-nama').value,
            tipe_sensor: document.getElementById('alat-tipe').value,
            kondisi_alat: document.getElementById('alat-kondisi').value,
            status_alat: document.getElementById('alat-status').value,
            id_lahan: lahanIdValue ? parseInt(lahanIdValue) : null,
        };
        if (!newAlat.nama_alat) {
            showAlert('Input Tidak Valid', 'Nama Alat tidak boleh kosong.');
            return;
        }

        if (id) {
            const index = db.alat.findIndex(a => a.id_alat == id);
            db.alat[index] = { ...db.alat[index], ...newAlat };
            showAlert('Sukses', 'Data alat berhasil diperbarui.');
        } else {
            newAlat.id_alat = getNewId(db.alat, 'id_alat');
            db.alat.push(newAlat);
            showAlert('Sukses', 'Data alat berhasil disimpan.');
        }
        renderAlatTable();
        renderDashboard();
        resetAlatForm();
    });
    const resetAlatForm = () => {
        document.getElementById('alat-form').reset();
        document.getElementById('alat-id').value = '';
        document.getElementById('alat-form-title').textContent = 'Tambah Alat Baru';
    };
    document.getElementById('alat-cancel').addEventListener('click', resetAlatForm);

    // Form Tanaman
    document.getElementById('tanaman-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('tanaman-id').value;
        const fields = [
            { name: 'lahan-id', key: 'id_lahan', type: 'integer', required: true, label: 'Lokasi Lahan' },
            { name: 'jenis', key: 'jenis_jagung', type: 'string', required: true, label: 'Jenis Jagung' },
            { name: 'tgl-tanam', key: 'tgl_tanam', type: 'string', required: true, label: 'Tanggal Tanam' },
            { name: 'umur-panen', key: 'umur_panen', type: 'integer', required: true, label: 'Umur Panen' }
        ];
        const newTanaman = validateAndGetData('tanaman', fields);
        if (!newTanaman) return;

        if (id) {
            const index = db.tanaman.findIndex(t => t.id_tanaman == id);
            db.tanaman[index] = { ...db.tanaman[index], ...newTanaman };
            showAlert('Sukses', 'Data tanaman berhasil diperbarui.');
        } else {
            newTanaman.id_tanaman = getNewId(db.tanaman, 'id_tanaman');
            db.tanaman.push(newTanaman);
            showAlert('Sukses', 'Data tanaman berhasil disimpan.');
        }
        renderTanamanTable();
        renderDashboard();
        resetTanamanForm();
    });
    const resetTanamanForm = () => {
        document.getElementById('tanaman-form').reset();
        document.getElementById('tanaman-id').value = '';
        document.getElementById('tanaman-form-title').textContent = 'Tambah Tanaman Baru';
    };
    document.getElementById('tanaman-cancel').addEventListener('click', resetTanamanForm);

    // Form Penyiraman
    document.getElementById('penyiraman-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('penyiraman-id').value;
        const fields = [
            { name: 'lahan-id', key: 'id_lahan', type: 'integer', required: true, label: 'Lahan' },
            { name: 'alat-id', key: 'id_alat', type: 'integer', required: false, label: 'Alat' },
            { name: 'tgl', key: 'tgl_waktu_siram', type: 'string', required: true, label: 'Tgl & Waktu' },
            { name: 'target', key: 'target_kelembapan', type: 'number', required: true, label: 'Target Kelembapan' },
            { name: 'durasi', key: 'durasi', type: 'integer', required: true, label: 'Durasi' },
            { name: 'volume', key: 'volume_air', type: 'number', required: true, label: 'Volume Air' }
        ];
        const newPenyiraman = validateAndGetData('penyiraman', fields);
        if (!newPenyiraman) return;

        // Transaksi simulasi
        newPenyiraman.id_penyiraman = getNewId(db.penyiraman, 'id_penyiraman');
        db.penyiraman.push(newPenyiraman);
        const lahanIndex = db.lahan.findIndex(l => l.id_lahan === newPenyiraman.id_lahan);
        if (lahanIndex !== -1) {
            db.lahan[lahanIndex].kelembapan = newPenyiraman.target_kelembapan;
        }
        
        showAlert('Sukses', 'Penyiraman berhasil dicatat dan kelembapan lahan telah diperbarui!');
        renderPenyiramanTable();
        renderLahanTable();
        renderDashboard();
        resetPenyiramanForm();
    });
    const resetPenyiramanForm = () => {
        document.getElementById('penyiraman-form').reset();
        document.getElementById('penyiraman-id').value = '';
        document.getElementById('penyiraman-form-title').textContent = 'Catat Penyiraman Baru';
    };
    document.getElementById('penyiraman-cancel').addEventListener('click', resetPenyiramanForm);

    // =================================================================================
    // LOGIKA EDIT & DELETE (Event Delegation)
    // =================================================================================
    document.body.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-petani-btn, .edit-lahan-btn, .edit-alat-btn, .edit-tanaman-btn');
        const deleteBtn = e.target.closest('.delete-petani-btn, .delete-lahan-btn, .delete-alat-btn, .delete-tanaman-btn, .delete-penyiraman-btn');

        if (editBtn) {
            const id = editBtn.dataset.id;
            if (editBtn.classList.contains('edit-petani-btn')) {
                const petani = db.petani.find(p => p.id_petani == id);
                document.getElementById('petani-id').value = petani.id_petani;
                document.getElementById('petani-nama').value = petani.nama_petani;
                document.getElementById('petani-hp').value = petani.no_hp;
                document.getElementById('petani-alamat').value = petani.alamat;
                document.getElementById('petani-form-title').textContent = 'Edit Data Petani';
            }
            if (editBtn.classList.contains('edit-lahan-btn')) {
                const lahan = db.lahan.find(l => l.id_lahan == id);
                document.getElementById('lahan-id').value = lahan.id_lahan;
                document.getElementById('lahan-petani-id').value = lahan.id_petani;
                document.getElementById('lahan-lokasi').value = lahan.lokasi;
                document.getElementById('lahan-luas').value = lahan.luas;
                document.getElementById('lahan-kelembapan').value = lahan.kelembapan;
                document.getElementById('lahan-status').value = lahan.status_lahan;
                document.getElementById('lahan-form-title').textContent = 'Edit Data Lahan';
            }
            if (editBtn.classList.contains('edit-alat-btn')) {
                const alat = db.alat.find(a => a.id_alat == id);
                document.getElementById('alat-id').value = alat.id_alat;
                document.getElementById('alat-nama').value = alat.nama_alat;
                document.getElementById('alat-tipe').value = alat.tipe_sensor;
                document.getElementById('alat-kondisi').value = alat.kondisi_alat;
                document.getElementById('alat-status').value = alat.status_alat;
                document.getElementById('alat-lahan-id').value = alat.id_lahan || '';
                document.getElementById('alat-form-title').textContent = 'Edit Data Alat';
            }
            if (editBtn.classList.contains('edit-tanaman-btn')) {
                const tanaman = db.tanaman.find(t => t.id_tanaman == id);
                document.getElementById('tanaman-id').value = tanaman.id_tanaman;
                document.getElementById('tanaman-lahan-id').value = tanaman.id_lahan;
                document.getElementById('tanaman-jenis').value = tanaman.jenis_jagung;
                document.getElementById('tanaman-tgl-tanam').value = tanaman.tgl_tanam;
                document.getElementById('tanaman-umur-panen').value = tanaman.umur_panen;
                document.getElementById('tanaman-form-title').textContent = 'Edit Data Tanaman';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        if (deleteBtn) {
            const id = parseInt(deleteBtn.dataset.id);
            if (deleteBtn.classList.contains('delete-petani-btn')) {
                showConfirm('Hapus Petani?', 'Menghapus petani akan menghapus semua data terkait (lahan, dll). Yakin?', () => {
                    db.petani = db.petani.filter(p => p.id_petani !== id);
                    db.lahan = db.lahan.filter(l => l.id_petani !== id); // Cascade delete
                    renderPetaniTable();
                    renderLahanTable();
                    renderDashboard();
                });
            }
            if (deleteBtn.classList.contains('delete-lahan-btn')) {
                showConfirm('Hapus Lahan?', 'Yakin ingin menghapus data lahan ini?', () => {
                    db.lahan = db.lahan.filter(l => l.id_lahan !== id);
                    renderLahanTable();
                    renderDashboard();
                });
            }
            if (deleteBtn.classList.contains('delete-alat-btn')) {
                showConfirm('Hapus Alat?', 'Yakin ingin menghapus data alat ini?', () => {
                    db.alat = db.alat.filter(a => a.id_alat !== id);
                    renderAlatTable();
                    renderDashboard();
                });
            }
            if (deleteBtn.classList.contains('delete-tanaman-btn')) {
                showConfirm('Hapus Tanaman?', 'Yakin ingin menghapus data tanaman ini?', () => {
                    db.tanaman = db.tanaman.filter(t => t.id_tanaman !== id);
                    renderTanamanTable();
                    renderDashboard();
                });
            }
            if (deleteBtn.classList.contains('delete-penyiraman-btn')) {
                showConfirm('Hapus Riwayat?', 'Yakin ingin menghapus riwayat ini?', () => {
                    db.penyiraman = db.penyiraman.filter(py => py.id_penyiraman !== id);
                    renderPenyiramanTable();
                    renderDashboard();
                });
            }
        }
    });
    
    // =================================================================================
    // LOGIKA REKOMENDASI CERDAS
    // =================================================================================
    const rekomPetaniSelect = document.getElementById('rekom-petani');
    const rekomLahanSelect = document.getElementById('rekom-lahan');
    const getRekomendasiBtn = document.getElementById('get-rekomendasi-btn');

    rekomPetaniSelect.addEventListener('change', () => {
        const petaniId = parseInt(rekomPetaniSelect.value);
        rekomLahanSelect.innerHTML = '<option value="">Pilih Lahan...</option>';
        if (petaniId) {
            db.lahan
                .filter(l => l.id_petani === petaniId && l.status_lahan === 'Aktif')
                .forEach(l => {
                    rekomLahanSelect.innerHTML += `<option value="${l.id_lahan}">${l.lokasi} (Kelembapan: ${l.kelembapan}%)</option>`;
                });
            rekomLahanSelect.disabled = false;
        } else {
            rekomLahanSelect.disabled = true;
        }
        getRekomendasiBtn.disabled = true;
    });

    rekomLahanSelect.addEventListener('change', () => {
        getRekomendasiBtn.disabled = !rekomLahanSelect.value;
    });

    getRekomendasiBtn.addEventListener('click', () => {
        const lahanId = parseInt(rekomLahanSelect.value);
        if (!lahanId) return;

        const lahan = db.lahan.find(l => l.id_lahan === lahanId);
        if (!lahan) return;

        const selisihKelembapan = TARGET_KELEMBAPAN_IDEAL - lahan.kelembapan;

        if (selisihKelembapan <= 0) {
            showAlert('Info', 'Kelembapan tanah sudah ideal. Tidak perlu penyiraman.');
            resetPenyiramanForm();
            return;
        }

        const totalVolumeAir = lahan.luas * selisihKelembapan * KEBUTUHAN_AIR_PER_METER_PER_PERSEN;
        const durasiMenit = totalVolumeAir / DEBIT_AIR_ALAT_PER_MENIT;

        document.getElementById('penyiraman-lahan-id').value = lahanId;
        document.getElementById('penyiraman-target').value = TARGET_KELEMBAPAN_IDEAL;
        document.getElementById('penyiraman-durasi').value = Math.round(durasiMenit);
        document.getElementById('penyiraman-volume').value = totalVolumeAir.toFixed(1);
        
        document.getElementById('penyiraman-tgl').value = new Date().toISOString().slice(0, 16);
        const alatSelect = document.getElementById('penyiraman-alat-id');
        alatSelect.innerHTML = '<option value="">Pilih Alat (Opsional)...</option>';
        db.alat.filter(a => a.id_lahan === lahanId && a.status_alat === 'Aktif' && a.tipe_sensor === 'Sensor Penyiraman').forEach(a => {
            alatSelect.innerHTML += `<option value="${a.id_alat}">${a.nama_alat}</option>`;
        });
        
        showAlert('Rekomendasi Dihasilkan', 'Formulir di bawah telah diisi dengan rekomendasi penyiraman. Silakan periksa dan simpan.');
    });
    
    // =================================================================================
    // INITIALIZATION
    // =================================================================================
    navigateTo('#dashboard');
});
</script>

</body>
</html>
